<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Phishing Detection System</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>

<body>

<div class="container">
    <h1>üîê Phishing Detection System</h1>
    <p class="accuracy">Model Accuracy: 94.2%</p>

    <!-- ================= TABS ================= -->
    <div class="tabs">
        <button class="tab {% if active_tab == 'email' %}active{% endif %}"
                onclick="showTab('email')">üìß Email</button>

        <button class="tab {% if active_tab == 'url' %}active{% endif %}"
                onclick="showTab('url')">üîó URL</button>
    </div>

    <!-- ================= EMAIL TAB ================= -->
    <div id="email" class="tab-content {% if active_tab == 'email' %}active{% endif %}">
        <form method="POST">
            <textarea name="email_text"
                      placeholder="Paste email content here..."
                      required>{{ email_text or '' }}</textarea>
            <button type="submit">Analyze Email</button>
        </form>

        {% if email_result %}
        <div class="result show {{ 'danger' if 'Phishing' in email_result else 'safe' }}">
            {{ email_result }}
        </div>
        {% endif %}

        {% if email_confidence %}
        <p class="confidence">Confidence: {{ email_confidence }}%</p>
        <div class="meter">
            <div class="meter-fill" style="width: {{ email_confidence }}%"></div>
        </div>
        {% endif %}
    </div>

    <!-- ================= URL TAB ================= -->
    <div id="url" class="tab-content {% if active_tab == 'url' %}active{% endif %}">
        <form method="POST">
            <input type="text"
                   name="url_text"
                   placeholder="Paste URL here (https://example.com)"
                   value="{{ url_text or '' }}"
                   required>
            <button type="submit">Analyze URL</button>
        </form>

        {% if url_result %}
        <div class="split-layout">

            <!-- LEFT: SHAP -->
            <div class="analysis-card-side">
                <h2>üß† AI Explainability (SHAP)</h2>

                <p class="analysis-sub">
                    This visualization explains <strong>why</strong> the model classified
                    this URL as <strong>{{ 'Phishing' if 'Phishing' in url_result else 'Safe' }}</strong>.
                </p>

                {% if shap_image %}
                <div class="shap-container-pro">
                    <img src="{{ url_for('static', filename=shap_image) }}"
                         alt="SHAP Explanation"
                         class="shap-graph-pro"
                         onclick="openShapModal(this)">
                </div>

                <div class="shap-legend-pro">
                    <span><span class="legend-dot red"></span> Increases phishing risk</span>
                    <span><span class="legend-dot green"></span> Indicates legitimacy</span>
                </div>

                <div class="shap-note">
                    ‚ÑπÔ∏è Features are extracted from URL structure, tokens, keywords, and domain patterns.
                    SHAP values quantify each feature‚Äôs contribution.
                </div>
                {% else %}
                <p class="shap-unavailable">SHAP explanation not available.</p>
                {% endif %}
            </div>

            <!-- RIGHT: RESULT -->
            <div class="result-section">
                <div class="result show {{ 'danger' if 'Phishing' in url_result else 'safe' }}">
                    {{ url_result }}
                </div>

                {% if url_confidence %}
                <div class="confidence-box">
                    <p class="confidence">Risk Score: {{ url_confidence }}%</p>
                    <div class="meter">
                        <div class="meter-fill" style="width: {{ url_confidence }}%"></div>
                    </div>
                </div>
                {% endif %}
            </div>

        </div>
        {% endif %}
    </div>
</div>

<!-- ================= SHAP MODAL ================= -->
<div id="shapModal" class="shap-modal" onclick="closeShapModal()">
    <img id="shapModalImg" class="shap-modal-img">
</div>

<!-- ================= JS ================= -->
<script>
function showTab(tab) {
    document.querySelectorAll('.tab').forEach(b => b.classList.remove('active'));
    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
    document.getElementById(tab).classList.add('active');
    document.querySelector(`[onclick="showTab('${tab}')"]`).classList.add('active');
}

function openShapModal(img) {
    const modal = document.getElementById("shapModal");
    const modalImg = document.getElementById("shapModalImg");
    modalImg.src = img.src;
    modal.style.display = "flex";
}

function closeShapModal() {
    document.getElementById("shapModal").style.display = "none";
}

window.onload = () => showTab('{{ active_tab }}');
</script>

<!-- ================= EXTRA CSS ================= -->
<style>

/* === SPLIT === */
.split-layout {
    display: flex;
    gap: 30px;
    margin-top: 25px;
}

/* === SHAP CARD === */
.analysis-card-side {
    flex: 2;
    background: #0f172a;
    padding: 25px;
    border-radius: 18px;
    box-shadow: 0 15px 40px rgba(0,0,0,0.3);
}

/* === SHAP IMAGE === */
.shap-graph-pro {
    width: 100%;
    max-height: 420px;
    object-fit: contain;
    border-radius: 12px;
    cursor: zoom-in;
    transition: transform 0.3s ease;
}

.shap-graph-pro:hover {
    transform: scale(1.03);
}

/* === MODAL === */
.shap-modal {
    display: none;
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.9);
    backdrop-filter: blur(6px);
    z-index: 9999;
    justify-content: center;
    align-items: center;
}

.shap-modal-img {
    max-width: 90%;
    max-height: 85%;
    border-radius: 16px;
    box-shadow: 0 30px 70px rgba(0,0,0,0.6);
}

/* === LEGEND === */
.shap-legend-pro {
    display: flex;
    justify-content: space-between;
    margin-top: 15px;
    font-size: 13px;
}

.legend-dot {
    width: 10px;
    height: 10px;
    border-radius: 50%;
    display: inline-block;
    margin-right: 6px;
}

.legend-dot.red { background: #ef4444; }
.legend-dot.green { background: #22c55e; }

/* === NOTES === */
.shap-note {
    margin-top: 15px;
    font-size: 12px;
    color: #cbd5f5;
}

/* === RESULT === */
.result-section {
    flex: 1;
}

</style>

</body>
</html>
